# CSLogbook Cursor Rules

## üéØ Critical Patterns (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å .github/copilot-instructions.md)

### 1. Database Associations - ‚ö†Ô∏è MOST COMMON ERROR
**ALWAYS use `as` keyword for multiple associations:**
```javascript
// ‚úÖ CORRECT - Check models/index.js for aliases
include: [{ model: User, as: 'owner' }]

// ‚ùå WRONG - Will throw "associated multiple times" error  
include: [{ model: User }]
```

### 2. API Response Format - MUST FOLLOW
```javascript
// Success
{ success: true, data: {...}, message: "..." }

// Error
{ success: false, error: "Error message", details: {...} }
```

### 3. Workflow State Management
**Always use workflowService for state changes:**
```javascript
await workflowService.updateStudentWorkflowActivity(
  studentId,
  'internship', // workflowType
  'STEP_KEY',   // stepKey from WorkflowStepDefinition
  'completed',  // stepStatus
  'in_progress', // overallStatus
  { metadata }  // optional payload
);
```

### 4. Timezone - CRITICAL for Thai dates
```javascript
// ‚úÖ CORRECT
const date = dayjs.tz(dateString, 'Asia/Bangkok');

// ‚ùå WRONG - Will cause timezone mismatch
const date = new Date(dateString);
```

### 5. Service Layer Architecture
```
Request ‚Üí Router ‚Üí Controller ‚Üí Service ‚Üí Model ‚Üí Database
         ‚Üì                      ‚Üì
    Validation          Business Logic
```
- **Controllers**: Handle HTTP requests/responses only
- **Services**: All business logic and database operations
- **Models**: Check `models/index.js` for associations

## üö´ Common Mistakes to AVOID

1. **Missing `as` in queries** with multiple associations (Document, User relations)
2. **Wrong timezone** - Always use Asia/Bangkok (+07:00)
3. **Direct model updates** - Use workflowService for workflow changes
4. **Inconsistent API format** - Follow success/error format above
5. **Missing utf8mb4** charset for Thai language support
6. **Forgetting to mount routes** in `app.js`
7. **Not checking associations** in `models/index.js` before queries

## üìù When Adding Features

### New API Endpoint:
1. Create route in `routes/` folder
2. Create controller method (handle HTTP only)
3. Implement service layer (business logic)
4. Mount route in `app.js`
5. Add JSDoc for Swagger

### New Database Table:
1. Create migration: `npm run migrate:create`
2. Add Sequelize model in `models/`
3. Define associations in `models/index.js`
4. Run migration: `npm run migrate`
5. Verify: `npm run db:check:all`

### New React Component:
1. Place in appropriate subdirectory: `components/admin/`, `student/`, `teacher/`, `common/`
2. Use Ant Design components (follow existing patterns)
3. Create service method if API needed
4. Error handling + loading states

## üîß Tech Stack

**Backend:**
- Express.js + Sequelize ORM
- MySQL 8.0 (utf8mb4_unicode_ci)
- JWT authentication
- Winston logging

**Frontend:**
- React 18
- Ant Design 5 (prefer built-in components)
- React Router v6
- Context API + custom hooks
- Axios with interceptors

**Key Directories:**
- `backend/controllers/` - HTTP handlers
- `backend/services/` - Business logic
- `backend/models/` - Sequelize models
- `backend/models/index.js` - ‚ö†Ô∏è All associations defined here
- `frontend/src/components/` - React components
- `frontend/src/services/` - API calls

## üîç Before Writing Code - CHECK THESE:

1. **Associations**: Read `models/index.js` for relationship aliases
2. **Existing patterns**: Search codebase for similar features
3. **Service layer**: Put logic in services, not controllers
4. **Workflow steps**: Check seeders for step definitions
5. **API format**: Follow success/error response structure

## üìö Reference Files:
- Architecture: `.github/copilot-instructions.md` (full details)
- Routes: `backend/app.js`
- Models: `backend/models/index.js`
- Frontend routes: `frontend/src/App.js`
- Workflows: `backend/seeders/*-initial-*-steps.js`

---
**Note**: This file is auto-loaded by Cursor. For full documentation, see `.github/copilot-instructions.md`

