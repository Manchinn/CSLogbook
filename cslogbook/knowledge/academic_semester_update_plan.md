# แผนปฏิบัติงานและการตั้งค่าอัปเดตภาคเรียนอัตโนมัติ

เอกสารนี้สรุปขั้นตอนสำหรับเจ้าหน้าที่ในการตรวจสอบและอัปเดตภาคเรียนด้วยตนเอง รวมถึงการกำหนดค่า Scheduler อัตโนมัติในระบบ CSLogbook

## 1. ปฏิทินงานเจ้าหน้าที่ (Manual Checklist)

| เวลา | งานที่ต้องทำ | รายละเอียด |
| --- | --- | --- |
| T-30 วันก่อนเปิดภาคเรียนถัดไป | ตรวจความพร้อมข้อมูล | ยืนยันว่า `semesterXRange`, ช่วงลงทะเบียน, และกำหนดการสำคัญถูกตั้งค่าครอบคลุมทั้งปี |
| T-14 วัน | ทดสอบหน้าการตั้งค่าปีการศึกษา | ล็อกอินหน้า Admin → การตั้งค่า → ปีการศึกษา/ภาคเรียน ตรวจสอบข้อมูล draft และแจ้งเตือนทีมที่เกี่ยวข้อง |
| T-7 วัน | เตรียมข้อมูลอัปเดต | ปรับ `currentSemester` ในฟอร์มให้เป็นภาคเรียนถัดไป (ยังไม่บันทึก) ตรวจสอบการทับซ้อนของช่วงเวลา |
| T-1 วัน | บันทึกค่าจริง | กดบันทึกให้ `currentSemester` เป็นภาคเรียนใหม่ ตรวจสอบ API `GET /api/academic/settings` ว่าข้อมูลใหม่ถูกต้อง |
| วันแรกของภาคเรียน | สุ่มตรวจ UI | เข้าดูหน้าแดชบอร์ดนักศึกษา/อาจารย์เพื่อยืนยันว่าข้อมูลภาคเรียนใหม่แสดงถูกต้อง |
| T+3 วัน | ประเมินผล | รวบรวม feedback หากพบการตั้งค่าผิดให้แก้ไขและบันทึกใน log ภายใน |

> **หมายเหตุ:** การบันทึกครั้งสุดท้ายควรทำหลังจากทุกทีมยืนยันช่วงเวลาแล้ว เพื่อลดการแก้ไขซ้ำในช่วงเปิดภาคเรียน

## 2. Scheduler อัปเดตภาคเรียนอัตโนมัติ

ตั้งแต่ Commit นี้ระบบมีตัว Scheduler (`backend/agents/schedulers/academicSemesterScheduler.js`) สำหรับปรับ `currentSemester` ให้ตรงกับวันที่จริงอัตโนมัติ พร้อมอัปเดตปีการศึกษาเมื่อเริ่มภาคเรียนที่ 1

### ขั้นตอนเปิดใช้งาน

1. เปิดไฟล์ `.env.development` (หรือ environment ที่ต้องการใช้งาน) แล้วตั้งค่า
   ```bash
   ACADEMIC_AUTO_UPDATE_ENABLED=true
   #ACADEMIC_AUTO_UPDATE_CRON=5 0 * * *
   ```
   - หากไม่กำหนด `ACADEMIC_AUTO_UPDATE_CRON` ระบบจะใช้เวลา 00:05 น. ทุกวัน (Asia/Bangkok)
2. รีสตาร์ต backend ให้ Agent โหลดค่าตัวแปรใหม่
3. ตรวจสอบ log (`backend/logs/agents.log` หรือ console) ควรเห็นข้อความ `AcademicSemesterScheduler: เริ่มงานอัปเดตภาคเรียนอัตโนมัติ`

### หลักการทำงาน

- อ่านตาราง `academics` ที่ `is_current = true`
- แปลงช่วงเวลา `semester1_range`, `semester2_range`, `semester3_range`
- เมื่อวันที่ปัจจุบันอยู่ในช่วงใด ชุด log จะอัปเดต `current_semester` เป็นค่าที่ตรงกัน
- หากเป็นภาคเรียนที่ 1 และปี พ.ศ. ในตารางไม่ตรงกับปีเริ่มต้นของช่วงเวลา ระบบจะอัปเดต `academic_year` ให้อัตโนมัติ
- รันอัตโนมัติทุกวันตาม cron และเรียกตรวจสอบทันทีหลังเริ่มงาน

### คำแนะนำเพิ่มเติม

- **ยังควรมีการตรวจสอบด้วยคน** ตามปฏิทินด้านบน โดยเฉพาะก่อนเริ่มภาคเรียน เพื่อให้แน่ใจว่า `semesterXRange` ถูกตั้งค่าถูกต้อง
- ในกรณีต้องการหยุดการทำงาน ชุด Agent จะหยุดเมื่อ `ACADEMIC_AUTO_UPDATE_ENABLED` ไม่ได้ตั้งเป็น `true` หรือใช้ `agentManager.stopAgent('academicSemesterScheduler')`
- หากช่วงเวลาถูกเว้นว่าง (ไม่ครอบคลุมวันที่ปัจจุบัน) Scheduler จะไม่แก้ไขค่าและจะบันทึก log แจ้งเตือน

เอกสารนี้ควรแนบไปกับ onboarding ของเจ้าหน้าที่และนักพัฒนาใหม่ เพื่อให้เข้าใจทั้งขั้นตอน Manual และการตั้งค่า Automation