# สรุปการทำงานของระบบแสดงสถานะการประเมินผลการฝึกงาน

เอกสารนี้อธิบายตรรกะการทำงานของฟังก์ชัน `getEvaluationStatus` ใน `internshipController.js` ซึ่งใช้สำหรับแสดงสถานะการประเมินผลการฝึกงานของนักศึกษา

## ภาพรวม

ฟังก์ชัน `getEvaluationStatus` มีจุดประสงค์เพื่อให้นักศึกษาทราบถึงสถานะปัจจุบันของการประเมินผลการฝึกงาน โดยพิจารณาจากข้อมูลหลายส่วน ได้แก่ สถานะของเอกสาร คพ.05 (คำร้องขอฝึกงาน), สถานะของเอกสาร แบบประเมินฝึกงาน (แบบประเมินผลการฝึกงาน), และวันที่สิ้นสุดการฝึกงาน

## ตรรกะการทำงานหลัก

1.  **ค้นหาข้อมูลนักศึกษา:**
    *   ระบบจะค้นหาข้อมูลนักศึกษาจาก `userId` ของผู้ใช้ที่ล็อกอินเข้ามา

2.  **ค้นหาเอกสารการฝึกงาน (InternshipDocument):**
    *   ระบบจะค้นหา `InternshipDocument` ล่าสุดที่เกี่ยวข้องกับนักศึกษา โดยจะต้องเป็นเอกสารประเภท `internship` (เช่น คพ.05)
    *   หากไม่พบข้อมูลนักศึกษา หรือไม่พบเอกสารการฝึกงาน จะแสดงข้อความว่า "ไม่พบข้อมูลนักศึกษา" หรือ "ไม่พบเอกสารการฝึกงาน (เช่น คพ.05) หรือข้อมูลการประเมิน"

3.  **ค้นหาแบบประเมินผล (แบบประเมินฝึกงาน - Evaluation Form):**
    *   ระบบจะค้นหาเอกสาร แบบประเมินฝึกงาน ล่าสุดของนักศึกษา (ถ้ามี)

4.  **กำหนดสถานะการประเมิน (`evaluationStatus`) และรายละเอียด (`evaluationDetails`):**

    *   **ค่าเริ่มต้น:**
        *   `evaluationStatus`: "ยังไม่ได้ประเมิน"
        *   `evaluationDetails`: `null`

    *   **เงื่อนไขหลัก: ตรวจสอบว่า คพ.05 (CS05) ได้รับการอนุมัติ (`approved`) หรือไม่**

        *   **กรณีที่ 1: คพ.05 ได้รับการอนุมัติแล้ว**
            *   **1.1 หากมีเอกสาร แบบประเมินฝึกงาน (Evaluation Form) อยู่ในระบบ:**
                *   `evaluationStatus` จะขึ้นอยู่กับสถานะของ แบบประเมินฝึกงาน:
                    *   ถ้า แบบประเมินฝึกงาน `status` เป็น `approved`: "ประเมินแล้ว"
                    *   ถ้า แบบประเมินฝึกงาน `status` เป็น `pending`: "รอการประเมิน"
                    *   ถ้า แบบประเมินฝึกงาน `status` เป็น `rejected`: "ประเมินแล้ว (ไม่ผ่าน)"
                    *   สถานะอื่นๆ ของ แบบประเมินฝึกงาน: "อยู่ระหว่างดำเนินการ"
                *   `evaluationDetails` จะประกอบด้วย: `status` (ของ แบบประเมินฝึกงาน), `filePath`, `comment`, `evaluatedAt`, `supervisorName`

            *   **1.2 หากยังไม่มีเอกสาร แบบประเมินฝึกงาน และวันที่สิ้นสุดการฝึกงาน (`internshipDocument.endDate`) ยังมาไม่ถึง (หรือเป็นวันปัจจุบัน):**
                *   `evaluationStatus`: "อยู่ระหว่างการฝึกงาน"
                *   `evaluationDetails`: ประกอบด้วย `status`: "อยู่ระหว่างการฝึกงาน", `supervisorName`, `endDate`

            *   **1.3 หากยังไม่มีเอกสาร แบบประเมินฝึกงาน และวันที่สิ้นสุดการฝึกงาน (`internshipDocument.endDate`) ผ่านไปแล้ว:**
                *   `evaluationStatus`: "รอสิ้นสุดการฝึกงานเพื่อประเมิน"
                *   `evaluationDetails`: ประกอบด้วย `status`: "รอการประเมินจากอาจารย์นิเทศก์ (สิ้นสุดการฝึกงานแล้ว)", `supervisorName`, `endDate`

        *   **กรณีที่ 2: คพ.05 ยังไม่ได้รับการอนุมัติ หรือมีสถานะการประเมินโดยตรงบน `InternshipDocument`** (เช่น ระบบเก่าหรือการอนุมัติแบบพิเศษ)
            *   **2.1 หาก `internshipDocument.document.status` เป็น `approved_evaluation`:**
                *   `evaluationStatus`: "ประเมินแล้ว"
                *   `evaluationDetails`: ประกอบด้วย `status`: "อนุมัติผลการฝึกงาน", `filePath` (ถ้ามี), `comment` (ถ้ามี), `evaluatedAt`, `supervisorName`
            *   **2.2 หาก `internshipDocument.document.status` เป็น `pending_evaluation`:**
                *   `evaluationStatus`: "รอการประเมิน"
                *   `evaluationDetails`: ประกอบด้วย `status`: "รอการประเมินจากอาจารย์นิเทศก์", `supervisorName`

## ข้อมูลที่ส่งกลับ (Response Data)

ฟังก์ชันจะส่งข้อมูลกลับในรูปแบบ JSON ประกอบด้วย:

*   `success`: (boolean) สถานะความสำเร็จของการดำเนินการ
*   `evaluationStatus`: (string) สถานะการประเมินหลักที่คำนวณได้
*   `evaluationDetails`: (object) รายละเอียดเพิ่มเติมเกี่ยวกับการประเมิน
*   `studentId`: (string) รหัสนักศึกษา
*   `companyName`: (string) ชื่อสถานประกอบการ

## การจัดการข้อผิดพลาด

ระบบมีการดักจับข้อผิดพลาดที่อาจเกิดขึ้น เช่น:
*   ไม่พบข้อมูลนักศึกษา
*   ไม่พบเอกสารการฝึกงาน
*   ปัญหาการเชื่อมต่อฐานข้อมูล
*   ข้อผิดพลาดเกี่ยวกับฟิลด์ในฐานข้อมูล

และจะส่ง `status code` พร้อมข้อความแสดงข้อผิดพลาดที่เหมาะสมกลับไป
